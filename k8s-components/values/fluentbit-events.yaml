serviceAccount:
  create: false
  name: observability-agent

kind: Deployment

nodeSelector:
  kubernetes.io/arch: arm64

rbac:
  create: false
  clusterRole: false

# [TODO] Update the image from Oracle Container Registry
# image:
#   repository: ocir.ap-mumbai-1.oci.oraclecloud.com/bmwva1xqkb3s/observability
#   tag: fluent-bit-4.0.0-arm64
#   pullPolicy: IfNotPresent

# imagePullSecrets:
# - name: ocirsecret

config:
  extraFiles:
    fluent-bit.yaml: |
      service:
        daemon: Off
        flush: 10
        grace: 10
        log_Level: info
        parsers_File: /fluent-bit/etc/parsers.conf
        HTTP_Server: On
        HTTP_Listen: 0.0.0.0
        HTTP_port: 2020
        Health_Check: On

      pipeline:
        inputs:
        - name: kubernetes_events
          tag: kube_events
          kube_URL: https://kubernetes.default.svc.cluster.local:443
          kube_CA_File: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          kube_Token_File: /var/run/secrets/kubernetes.io/serviceaccount/token

        filters:
        - name: nest
          match: kube_events
          operation: lift
          nested_under: involvedObject
          add_prefix: resource_

        - name: modify
          match: kube_events
          add: tenancy c001b

        - name: record_modifier
          match: kube_events
          remove_key:
          - metadata
          - source
          - firstTimestamp
          - lastTimestamp
          - eventTime
          - resource_uid
          - resource_resourceVersion

        outputs:
        - name: loki
          match: kube_events
          host: 10.251.0.48
          port: 80
          labels: service=k8s_event,namespace=$resource_namespace,kind=$resource_kind,cluster=$tenancy,name=$resource_name,level=$type

args:
- --workdir=/fluent-bit/etc
- --config=/fluent-bit/etc/conf/fluent-bit.yaml

resources:
  requests:
    cpu: 100m
    memory: 125Mi
  limits:
    cpu: 200m
    memory: 250Mi