serviceAccount:
  create: false
  name: observability-agent

nodeSelector:
  kubernetes.io/arch: arm64

rbac:
  create: false
  clusterRole: false

# [TODO] Update the image from Oracle Container Registry
# image:
#   repository: ocir.ap-mumbai-1.oci.oraclecloud.com/bmwva1xqkb3s/observability
#   tag: fluent-bit-4.0.0-arm64
#   pullPolicy: IfNotPresent

# imagePullSecrets:
# - name: ocirsecret

daemonSetVolumes:
- name: varlog
  hostPath:
    path: /var/log
- name: varlibdockercontainers
  hostPath:
    path: /var/lib/docker/containers
- name: etcmachineid
  hostPath:
    path: /etc/machine-id
    type: File
- name: systemd
  hostPath:
    path: /run/log/journal

daemonSetVolumeMounts:
- name: varlog
  mountPath: /var/log
- name: varlibdockercontainers
  mountPath: /var/lib/docker/containers
  readOnly: true
- name: etcmachineid
  mountPath: /etc/machine-id
  readOnly: true
- name: systemd
  mountPath: /run/log/journal
  readOnly: true

config:
  extraFiles:
    fluent-bit.yaml: |
      service:
        daemon: Off
        flush: 10
        grace: 10
        log_Level: info
        parsers_File: /fluent-bit/etc/parsers.conf
        HTTP_Server: On
        HTTP_Listen: 0.0.0.0
        HTTP_port: 2020
        Health_Check: On

      parsers:
        - name: argocd_json_parser
          format: json
          time_key: time
          time_format: "%Y-%m-%dT%H:%M:%SZ"

      pipeline:
        inputs:
        - name: tail
          tag: kube.var.log.containers.*
          path: /var/log/containers/*.log
          exclude_path:
            - /var/log/containers/*argocd*.log
          parser: cri
          db: /var/log/flb_log.db
          refresh_interval: 5
          rotate_wait: 30
          db.sync: normal
          buffer_max_size: 200M
          buffer_chunk_size: 1.5M

        - name: tail
          tag: kube.var.log.containers.*
          path: /var/log/containers/*argocd*.log
          parser: cri
          db: /var/log/flb_argo_log.db
          rotate_wait: 5
          db.sync: normal
          buffer_max_size: 100M

        - name: systemd
          tag: kubelet.systemd
          systemd_filter: _SYSTEMD_UNIT=kubelet.service
          path: /run/log/journal
          db: /var/log/flb_systemd.db
          db.sync: Full
          strip_underscores : on
          lowercase: on

        filters:
        - name: kubernetes
          match: kube.var.log.containers.*
          kube_tag_prefix: kube.var.log.containers.
          merge_log: On
          keep_log: Off
          k8s-logging.exclude: On
          buffer_size: 220M
          kube_url: https://kubernetes.default.svc.cluster.local:443
          kube_ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          kube_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
          use_kubelet: true
          kubelet_port: 10250
          tls.verify: on
          kubelet_host: ${HOST_IP}

        - name: parser
          match: kube.var.log.containers.*argocd*
          key_name: message
          parser: argocd_json_parser
          reserve_data: On

        - name: parser
          match: kube.var.log.containers.*
          key_name: message
          parser: json
          reserve_data: On

        - name: nest
          match: kube.var.log.containers.*
          operation: lift
          nested_under: kubernetes
          add_prefix: kubernetes_

        - name: modify
          match: kube.var.log.containers.*
          add: tenancy c001b
          remove:
          - kubernetes_pod_id
          - kubernetes_labels
          - kubernetes_annotations
          - kubernetes_docker_id
          - kubernetes_container_hash
          - kubernetes_container_image

        - name:  modify
          match: kubelet.systemd
          add: tenancy c001b
          remove:
          - cmdline
          - exe
          - selinux_context
          - cap_effective
          - stream_id
          - transport
          - systemd_invocation_id
          - systemd_cgroup
          - boot_id
          - machine_id
          - gid
          - uid
          - systemd_slice
          - syslog_identifier
          - priority
          - comm
          - systemd_unit

        outputs:
        - name: loki
          match: kube.var.log.containers.*
          host: 10.251.0.48
          port: 80
          labels: service=biz_pod_logs,pod_name=$kubernetes_pod_name,namespace=$kubernetes_namespace_name,cluster=$tenancy,host_ip=${HOST_IP},request_path=$request_path,user_uuid=$user_uuid,vm_id=$vm_id,fn_id=$fn_id,sss_status=$sss_status,level=$level
          line_format: json

        - name: loki
          match: kubelet.systemd
          host: 10.251.0.48
          port: 80
          labels: service=biz_kubelet_logs,cluster=$tenancy,host_ip=${HOST_IP}
          Log_Level: info
          line_format: json

args:
- --workdir=/fluent-bit/etc
- --config=/fluent-bit/etc/conf/fluent-bit.yaml

env:
- name: HOST_IP
  valueFrom:
    fieldRef:
      fieldPath: status.hostIP

resources:
  requests:
    cpu: 200m
    memory: 125Mi
  limits:
    cpu: 400m
    memory: 250Mi